# Email Chronology v1.0.3 - Project Context for Claude

## Project Overview

**Email Chronology v1.0.3** is a web application that parses long email chains from `.msg` (Outlook message) files into individual email messages, then displays them in chronological order with alternating left/right alignment in a scrollable timeline view.

### Core Purpose

The fundamental purpose of this app is to:

1. **Parse email chains**: Extract individual email messages from forwarded email chains within `.msg` files
2. **Create individual cards**: Generate a card for each individual email message found
3. **Sort chronologically**: Organize ALL email messages from ALL `.msg` files by date/time (oldest on top)
4. **Display in timeline**: Present messages in a single long scrollable sequence with alternating left/right alignment (like a conversation thread)

This allows users to view complex, forwarded email chains as a clean, chronological timeline where they can scroll through using the scrollbar to see the conversation unfold in order.

## Technology Stack

- **Frontend**: Vanilla JavaScript (ES6 modules)
- **Build Tool**: Vite 5.0
- **Dev Server**: Vite dev server (port 3000)
- **Dependencies**:
  - `@kenjiuno/msgreader` - Parses .msg files
  - `vite-plugin-node-polyfills` - Provides Node.js polyfills for Buffer, global, and process

## Project Structure

```
Email Chronology v1.0.3/
├── index.html              # Main HTML file with app structure
├── package.json            # Dependencies and scripts
├── vite.config.js          # Vite configuration with Node polyfills
├── js/                     # JavaScript modules (ES6)
│   ├── app.js             # Main application controller
│   ├── emailChain.js      # Email chain management and rendering
│   ├── msgParser.js       # Main .msg file parsing coordinator
│   ├── chainParser.js     # Forwarded chain detection and parsing
│   ├── boundaryDetector.js # Message boundary detection in chains
│   ├── emailExtractor.js  # Email metadata extraction from text
│   ├── bodyExtractor.js   # Body and attachment extraction
│   ├── formatters.js      # Email address and date formatting
│   ├── textUtils.js       # Text cleaning and date parsing utilities
│   ├── queue.js           # File processing queue
│   └── toast.js           # Toast notification system
├── css/
│   └── styles.css         # Application styles
├── assets/                # Built assets (generated by Vite)
├── deprecated/            # Backup files
├── test/                  # Test files/data
└── .claude/               # Claude Code configuration
    └── commands/
        └── streamline.md  # Custom Claude command
```

## Core Architecture

### Data Flow

1. User drops/selects `.msg` files
2. **app.js** validates files and adds them to the processing queue
3. **queue.js** processes files one at a time
4. **msgParser.js** coordinates parsing:
   - Uses `@kenjiuno/msgreader` to parse .msg file structure
   - Calls **chainParser.js** to detect if body contains a forwarded email chain
   - **chainParser.js** uses **boundaryDetector.js** to find message boundaries
   - **emailExtractor.js** extracts individual emails from detected sections
   - **bodyExtractor.js**, **formatters.js**, and **textUtils.js** handle data extraction/cleaning
5. Parsed emails (array) are returned to **app.js**
6. **emailChain.js** adds emails to the collection (deduplicating and sorting)
7. **emailChain.js** renders emails in chronological order with alternating alignment

### Module Responsibilities

#### 1. **app.js** (`Email Chronology v1.0.3App` class)
Main application controller that orchestrates the entire app.

**Responsibilities:**
- Initializes DOM elements and event listeners
- Handles drag-and-drop file operations
- Validates file types (only `.msg` files)
- Manages file processing workflow via queue
- Coordinates between queue, parser, and email chain
- Handles "Clear All" functionality with confirmation

**Key Methods:**
- `handleFiles(files)` - Validates and queues .msg files
- `processFile(file)` - Processes a single .msg file
- `clearAll()` - Clears all emails with user confirmation

#### 2. **emailChain.js** (`EmailChain` class)
Manages the collection of email messages and renders them in chronological order.

**Responsibilities:**
- Stores emails in a Map for deduplication (by unique ID)
- Generates unique email IDs based on date, subject, from, and body preview
- Sorts emails chronologically (earliest first, oldest on top)
- Groups emails by source `.msg` file for display
- Renders email cards with alternating left/right alignment
- Toggles UI between empty state and email list
- Handles XSS prevention via HTML escaping

**Key Methods:**
- `addEmail(email)` - Adds email to collection, returns false if duplicate
- `generateEmailId(email)` - Creates unique identifier for deduplication
- `getSortedEmails()` - Returns emails sorted chronologically
- `groupBySourceFile(sortedEmails)` - Groups emails by source file
- `createFileGroupElement(group, index)` - Creates file group with alternating alignment
- `render()` - Renders the entire email timeline

**Display Logic:**
- Emails are grouped by source `.msg` file
- Each group is a "file-group" container (paper sheet style)
- Groups alternate between left and right alignment
- Within each group, individual email cards are displayed
- All emails across all files are sorted chronologically

#### 3. **msgParser.js**
Main coordinator for parsing `.msg` files. Acts as the entry point for all parsing operations.

**Responsibilities:**
- Uses `@kenjiuno/msgreader` library to parse `.msg` file structure
- Extracts basic email metadata (from, to, cc, date, subject)
- Calls specialized modules for body/attachment extraction
- Calls **chainParser.js** to detect and parse forwarded email chains
- Returns array of email objects (single email or multiple if chain detected)

**Key Function:**
- `parseMsgFile(file)` - Parses .msg file, returns array of email objects

**Return Value:**
- Array of email objects with structure:
  ```javascript
  {
    from: string,
    to: string,
    cc: string,
    date: Date,
    subject: string,
    body: string,
    attachments: Array<string>,
    sourceFile: string
  }
  ```

#### 4. **chainParser.js**
Detects and parses forwarded email chains within email bodies.

**Responsibilities:**
- Identifies if an email body contains a forwarded chain
- Coordinates boundary detection and email extraction
- Returns array of individual emails if chain detected
- Returns empty array if not a chain (use original email instead)

**Key Function:**
- `parseForwardedChain(email, sourceFile)` - Detects chain and extracts emails

**Logic:**
- Uses **boundaryDetector.js** to find message boundaries
- For each boundary, extracts the text section
- Uses **emailExtractor.js** to parse each section
- Only returns emails if multiple messages found (length > 1)

#### 5. **boundaryDetector.js**
Identifies where individual messages start within a forwarded email chain.

**Responsibilities:**
- Analyzes email body text to find message boundaries
- Detects patterns like "From:", "On [date]...wrote:", and separator lines
- Returns array of character positions where messages start

**Key Function:**
- `identifyMessageBoundaries(body)` - Returns array of boundary positions

**Detection Patterns:**
1. `From:` at start of line followed by other headers (To:/Date:/Cc:)
2. `On [date]...wrote:` lines (common reply/forward indicator)
3. Separator lines (20+ underscores or dashes)

#### 6. **emailExtractor.js**
Extracts email metadata from text sections (forwarded email headers).

**Responsibilities:**
- Parses text sections to extract From, To, Cc, Date, Subject
- Handles multi-line headers
- Extracts body content after headers
- Uses **textUtils.js** for date parsing and text cleaning

**Key Function:**
- `extractEmailFromSection(section)` - Returns email object or null

**Parsing Logic:**
- Skips "On...wrote:" lines
- Parses headers (From:, To:, Cc:, Date:/Sent:, Subject:)
- Handles multi-line header continuation
- Extracts body as everything after headers
- Only returns if minimum metadata found (sender/recipient + date/subject)

#### 7. **bodyExtractor.js**
Handles email body and attachment extraction.

**Responsibilities:**
- Prefers plain text body over HTML
- Converts HTML body to plain text if needed
- Extracts attachment names from attachment array

**Key Functions:**
- `extractBody(fileData)` - Returns plain text body
- `extractAttachments(attachments)` - Returns array of attachment names
- `htmlToPlainText(html)` - Converts HTML to plain text (internal)

#### 8. **formatters.js**
Formats email addresses, recipients, and dates.

**Responsibilities:**
- Formats email addresses with display names
- Filters and formats recipient lists (To/Cc)
- Parses various date formats to Date objects

**Key Functions:**
- `formatAddress(name, email)` - Returns "Name <email>" format
- `formatRecipients(recipients, type)` - Formats To or Cc recipients
- `parseDate(dateValue)` - Parses date string/object to Date

#### 9. **textUtils.js**
Text processing utilities for cleaning and date parsing.

**Responsibilities:**
- Cleans email text (removes mailto: links, extra whitespace)
- Parses flexible date formats (handles various email date formats)
- Handles Outlook-style date formats

**Key Functions:**
- `cleanEmailText(text)` - Cleans and normalizes text
- `parseFlexibleDate(dateStr)` - Parses various date formats

#### 10. **queue.js** (`ProcessingQueue` class)
Manages asynchronous file processing queue with visual feedback.

**Responsibilities:**
- Queues multiple files for processing
- Processes files one at a time sequentially
- Displays queue status and progress
- Shows current file being processed
- Provides visual feedback during processing

**Key Methods:**
- `addFiles(files)` - Adds files to queue and starts processing
- `processNext()` - Processes next file in queue
- `updateStatus()` - Updates UI with queue status

#### 11. **toast.js** (`ToastManager` class)
Displays temporary notification messages.

**Responsibilities:**
- Shows error and info notifications
- Auto-dismisses after configurable timeout
- Allows manual close
- Manages multiple toasts
- Provides closeAll() for bulk dismissal

**Key Methods:**
- `showError(title, message)` - Shows error toast
- `showInfo(title, message)` - Shows info toast
- `closeAll()` - Closes all active toasts

## Key Features

### Email Chain Parsing
- **Automatic detection**: Detects forwarded email chains within .msg files
- **Individual extraction**: Splits chains into individual email messages
- **Pattern recognition**: Identifies message boundaries using multiple patterns
- **Metadata extraction**: Extracts From, To, Cc, Date, Subject from text

### Display and Organization
- **Chronological ordering**: Sorts ALL emails by date/time (oldest first/top)
- **Alternating alignment**: File groups alternate left/right for visual distinction
- **File grouping**: Emails from same .msg file grouped in "paper sheet" containers
- **Scrollable timeline**: Single continuous timeline that users scroll through
- **Source tracking**: Each email tagged with source `.msg` filename

### User Experience
- **Drag & Drop**: Drop `.msg` files anywhere in the app
- **Click to browse**: Click empty state to browse for files
- **Processing queue**: Visual feedback for multiple file uploads
- **Duplicate detection**: Automatically ignores duplicate emails
- **Full headers**: Displays From, To, Cc, Date, and Subject
- **Attachment list**: Shows attachment names (files not extracted)
- **Plain text display**: HTML emails converted to plain text
- **Error handling**: Toast notifications for parsing errors
- **Clear all**: Resets application with confirmation dialog

## Code Conventions

### JavaScript Style
- ES6 modules with explicit imports/exports
- Class-based architecture with single responsibility
- JSDoc comments for functions and methods
- Descriptive method names (e.g., `generateEmailId`, `identifyMessageBoundaries`)
- Consistent error handling with try-catch blocks
- Pure functions for utilities (no side effects)

### Module Organization
- **One responsibility per module**: Each module has a clear, single purpose
- **Utility modules**: Stateless functions for reusable operations (formatters, textUtils)
- **Service modules**: Classes for stateful operations (EmailChain, ProcessingQueue, ToastManager)
- **Coordinator modules**: Functions that orchestrate other modules (msgParser, chainParser)

### DOM Manipulation
- Direct DOM element references stored in instance properties
- Event delegation where appropriate
- `classList` for CSS class toggling
- `innerHTML` for complex template rendering (with escaping)
- `textContent` for XSS-safe text insertion

### Security
- HTML escaping for all user-provided content via `escapeHtml()` method
- XSS prevention in emailChain.js
- File type validation (only `.msg` files accepted)
- No execution of user-provided code

## Development Workflow

### Running the App
```bash
npm install          # Install dependencies
npm run dev          # Start dev server (port 3000)
npm run build        # Build for production
npm run preview      # Preview production build
```

### Committing Changes
**IMPORTANT**: Before every commit and push, you MUST update the commit date in `index.html`:

1. Get the current date/time in PST (Pacific Standard Time - Vancouver, BC) using:
   ```bash
   TZ='America/Vancouver' git log -1 --format="%cd" --date=format:"%I:%M%p on %B %d, %Y"
   ```
2. Update the commit date in the `.commit-date` div in `index.html` (around line 16)
3. Format: "Commit date: HH:MM(AM/PM) on Month DD, YYYY" (in PST)

This ensures the live app displays the correct version information to users in Pacific Standard Time.

### Build Configuration
- Base path: `/Email Chronology v1.0.3/` (configured for GitHub Pages)
- Output directory: `dist/`
- Development server runs on port 3000
- Auto-opens browser on dev server start

## Important Implementation Details

### Email Chain Detection and Parsing

The app uses a sophisticated multi-stage pipeline to detect and parse forwarded email chains:

1. **Boundary Detection** (boundaryDetector.js):
   - Scans email body for patterns indicating message starts
   - Looks for "From:" headers, "On...wrote:" lines, separator lines
   - Returns character positions of detected boundaries

2. **Section Extraction** (chainParser.js):
   - Splits email body into sections based on boundaries
   - Each section represents one potential email message

3. **Metadata Extraction** (emailExtractor.js):
   - Parses each section to extract email headers
   - Handles multi-line headers and various formats
   - Validates that minimum metadata exists

4. **Result Validation** (chainParser.js):
   - Only returns extracted emails if multiple messages found
   - Falls back to original email if chain detection fails

### Email Deduplication

Emails are deduplicated using a composite key generated from:
```javascript
const emailId = [
    email.date?.toISOString() || '',
    email.subject || '',
    email.from || '',
    (email.body || '').substring(0, 100)
].join('|||');
```

This ensures the same email from different files or duplicates within a chain are only shown once.

### Chronological Sorting

All emails from all files are sorted in ascending chronological order (earliest/oldest first):
```javascript
emailArray.sort((a, b) => {
    const dateA = a.date || new Date(0);
    const dateB = b.date || new Date(0);
    return dateA - dateB; // Ascending order
});
```

This creates a true timeline view where users scroll from oldest (top) to newest (bottom).

### Alternating Alignment Display

Emails are grouped by source `.msg` file, and groups alternate alignment:
- File groups at even indices (0, 2, 4...) align left
- File groups at odd indices (1, 3, 5...) align right
- This creates a conversation-like visual flow
- Users scroll through the timeline using the scrollbar

### Node.js Polyfills

Required for `@kenjiuno/msgreader` to work in browser:
- **Buffer**: For binary data handling
- **global**: Global object reference
- **process**: Process information

These are provided by `vite-plugin-node-polyfills` configured in `vite.config.js`.

## UI/UX Patterns

1. **Empty State**: Large drop zone shown when no emails loaded
   - Click to browse or drag-and-drop files
   - Clear call-to-action

2. **Active State**: Email timeline with smaller drag overlay
   - Can still drag-and-drop to add more files
   - Overlay appears on drag to indicate drop target

3. **Queue Feedback**: Visual indicator showing processing status
   - Shows "Processing X of Y files"
   - Updates as files are processed

4. **File Groups**: Emails grouped by source file
   - Filename header at top of each group
   - Alternating left/right alignment
   - Paper sheet visual style

5. **Email Cards**: Individual email messages within groups
   - Full headers (From, To, Cc, Date)
   - Subject line
   - Body text (plain text)
   - Attachment list (if any)

6. **Toast Notifications**: Non-intrusive error/info messages
   - Auto-dismiss after timeout
   - Manual close button
   - Duplicate and error notifications

7. **Confirmation Dialogs**: Used for destructive actions
   - Clear All requires confirmation
   - Shows count of emails being cleared

## Common Tasks

### Adding a New Feature
1. Identify the appropriate module or create a new one
2. Follow single responsibility principle
3. Add JSDoc comments
4. Import and use in relevant coordinator (usually app.js or msgParser.js)
5. Test with various .msg files

### Modifying Email Display
- Edit `emailChain.js` methods:
  - `createFileGroupElement()` - File group styling/structure
  - `createEmailElement()` - Email card structure
  - `createHeaderHtml()` - Email headers
  - `createBodyHtml()` - Email body
  - `createAttachmentsHtml()` - Attachments
- Update corresponding CSS in `css/styles.css`

### Changing Parsing Logic
- **For .msg file parsing**: Modify `msgParser.js`
- **For chain detection**: Modify `boundaryDetector.js` patterns
- **For email extraction**: Modify `emailExtractor.js` header parsing
- **For date parsing**: Modify `textUtils.js` date functions
- **For formatting**: Modify `formatters.js`

### Adjusting Chain Detection
- Modify `boundaryDetector.js` to add/change patterns
- Test with various forwarded email formats
- Ensure false positives don't break single emails

### Adjusting Queue Behavior
- Edit `queue.js` ProcessingQueue class
- Update UI elements in `index.html` if needed
- Consider async/await patterns for sequencing

## Known Limitations

1. **Attachment Access**: Attachments are listed but not extracted/downloadable
2. **HTML Rendering**: HTML emails converted to plain text (no rich formatting, images, or styles)
3. **Large Files**: No progress bar for individual large .msg files (only queue progress)
4. **Browser Support**: Requires modern browser with ES6 module support
5. **Chain Detection**: May not detect all forwarded email formats (depends on email client)
6. **Inline Images**: Inline images in HTML emails are lost in plain text conversion
7. **Complex Threading**: Only handles forwarded chains, not complex reply threading

## Testing Considerations

### File Types
- Test with various .msg file sizes
- Test with single emails vs. forwarded chains
- Test with different email clients (Outlook versions, Exchange, etc.)

### Email Content
- Emails with various header combinations (missing Cc, missing Date, etc.)
- Emails with attachments
- Emails with HTML bodies
- Emails with plain text bodies
- Emails with inline images
- Forwarded chains with multiple levels

### Chain Detection
- Single emails (should not be split)
- Forwarded chains (should be split)
- Various forwarding formats (Outlook, Gmail, etc.)
- Edge cases (malformed headers, unusual formatting)

### Functionality
- Duplicate email detection
- Chronological sorting across multiple files
- File queue processing
- Error handling for invalid files
- Drag-and-drop in both empty and active states
- Clear All functionality

## Deployment

### GitHub Pages Setup

The app is configured for GitHub Pages with base path `/Email Chronology v1.0.3/`.

**Automatic Deployment:**
A GitHub Actions workflow (`.github/workflows/deploy.yml`) automatically builds and deploys the app when changes are pushed to the `main` branch.

**Workflow:**
1. Changes pushed to `main` branch
2. GitHub Actions runs build process
3. Vite builds app to `dist/` directory
4. Built files deployed to GitHub Pages
5. Live site updates automatically

**First-time Setup:**
1. Go to GitHub repository Settings → Pages
2. Under "Build and deployment", set Source to "GitHub Actions"
3. Push changes to `main` branch to trigger deployment
4. Workflow will build and deploy automatically

**Manual Deployment (if needed):**
1. Run `npm run build` to create the `dist/` folder
2. Use `git subtree push --prefix dist origin gh-pages` to push only the dist folder
3. Ensure GitHub Pages is configured to serve from the gh-pages branch

Built files in `dist/` directory are ready to be served by any static hosting provider.

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                         User Action                          │
│              (Drop/Select .msg files)                        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    app.js (Controller)                       │
│  - Validates .msg files                                      │
│  - Adds to queue                                             │
│  - Coordinates processing                                    │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│               queue.js (ProcessingQueue)                     │
│  - Manages file queue                                        │
│  - Processes one file at a time                              │
│  - Shows status                                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              msgParser.js (Coordinator)                      │
│  - Parses .msg file with @kenjiuno/msgreader                │
│  - Extracts metadata                                         │
│  - Calls chainParser                                         │
└─────┬───────────────────────────────────────────┬───────────┘
      │                                           │
      │ Uses:                                     │ Uses:
      ▼                                           ▼
┌──────────────────┐  ┌───────────────┐  ┌──────────────────┐
│  formatters.js   │  │textUtils.js   │  │bodyExtractor.js  │
│  - Format addr   │  │- Clean text   │  │- Extract body    │
│  - Format recip  │  │- Parse dates  │  │- Extract attach  │
│  - Parse dates   │  │               │  │- HTML→plaintext  │
└──────────────────┘  └───────────────┘  └──────────────────┘
      │
      │ If body contains chain:
      ▼
┌─────────────────────────────────────────────────────────────┐
│              chainParser.js (Coordinator)                    │
│  - Detects if email is a forwarded chain                    │
│  - Extracts individual messages                              │
│  - Returns array of emails                                   │
└─────┬───────────────────────────────────────────┬───────────┘
      │                                           │
      │ Uses:                                     │ Uses:
      ▼                                           ▼
┌─────────────────────┐              ┌──────────────────────┐
│ boundaryDetector.js │              │ emailExtractor.js    │
│ - Find "From:"      │              │ - Parse headers      │
│ - Find "On...wrote:"│              │ - Extract metadata   │
│ - Find separators   │              │ - Extract body       │
└─────────────────────┘              └──────────────────────┘
      │
      └───────────────────┬───────────────────────┘
                          │ Returns: Array<Email>
                          ▼
┌─────────────────────────────────────────────────────────────┐
│            emailChain.js (EmailChain class)                  │
│  - Stores emails in Map (deduplication)                     │
│  - Sorts chronologically (oldest first)                      │
│  - Groups by source file                                     │
│  - Renders with alternating alignment                        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    Rendered Timeline                         │
│  - File groups with alternating left/right alignment        │
│  - Email cards within groups                                 │
│  - Chronologically ordered (scrollable)                      │
└─────────────────────────────────────────────────────────────┘
```

## Troubleshooting

### Common Issues

**Issue**: Emails not detected as a chain
- **Solution**: Check `boundaryDetector.js` patterns - may need to add new pattern for that email format

**Issue**: Wrong date order
- **Solution**: Check date parsing in `textUtils.js` - may need to handle new date format

**Issue**: Duplicate emails appearing
- **Solution**: Check `generateEmailId()` in `emailChain.js` - may need to adjust deduplication logic

**Issue**: Headers not parsed correctly
- **Solution**: Check `emailExtractor.js` - may need to handle multi-line headers differently

**Issue**: Build fails
- **Solution**: Check `vite.config.js` - ensure Node polyfills are configured correctly
